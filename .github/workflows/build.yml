name: Build PlayUA Desktop Client

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"
  pull_request:

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt -r requirements-build.txt

      - name: Build on macOS
        if: runner.os == 'macOS'
        shell: bash
        run: bash ./scripts/build.sh

      - name: Build on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: powershell -ExecutionPolicy Bypass -File .\scripts\build.ps1

      - name: Package artifact (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          cd dist
          zip -r ../playua-desktop-client-macos.zip playua-desktop-client.app playua-desktop-client

      - name: Package artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path dist\playua-desktop-client\* -DestinationPath playua-desktop-client-windows.zip -Force

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playua-desktop-client-${{ runner.os }}
          path: |
            playua-desktop-client-macos.zip
            playua-desktop-client-windows.zip
          if-no-files-found: error

  release:
    name: Publish GitHub Release
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine release tag
        id: tag
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            PRERELEASE="false"
          else
            TAG_NAME="auto-${GITHUB_RUN_NUMBER}-${GITHUB_SHA::7}"
            PRERELEASE="true"
          fi
          echo "tag_name=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"

      - name: Create and push auto tag (branch pushes)
        if: startsWith(github.ref, 'refs/heads/')
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.tag.outputs.tag_name }}"
          git push origin "${{ steps.tag.outputs.tag_name }}"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Create release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          target_commitish: ${{ github.sha }}
          prerelease: ${{ steps.tag.outputs.prerelease }}
          generate_release_notes: true
          files: |
            release-assets/**/playua-desktop-client-macos.zip
            release-assets/**/playua-desktop-client-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old auto releases (keep latest 4)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner,
              repo,
              per_page: 100,
            });

            const autoReleases = releases
              .filter(r => r.tag_name && r.tag_name.startsWith("auto-"))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const toDelete = autoReleases.slice(4);
            core.info(`Auto releases found: ${autoReleases.length}. Deleting: ${toDelete.length}`);

            for (const rel of toDelete) {
              core.info(`Deleting release ${rel.id} (${rel.tag_name})`);
              await github.rest.repos.deleteRelease({
                owner,
                repo,
                release_id: rel.id,
              });

              try {
                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `tags/${rel.tag_name}`,
                });
                core.info(`Deleted tag ${rel.tag_name}`);
              } catch (err) {
                core.warning(`Failed to delete tag ${rel.tag_name}: ${err.message}`);
              }
            }
